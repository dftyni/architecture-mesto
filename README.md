Проектная работа: отказоустойчивость и масштабируемость MongoDB

Описание:
В этой работе реализована архитектура микросервисного приложения с использованием MongoDB, шардирования, репликации, кэширования через Redis, балансировки запросов через Nginx и эмуляцией CDN. Работа выполнена вручную, без использования готового шаблона, с постепенной сборкой и тестированием каждого этапа. Конфигурация системы адаптирована под реальные условия.
Я реализовал всё вручную, осознанно отойдя от шаблонов. В процессе у меня были сложности с использованием образа "kazhem/pymongo_api:1.0.0" и далее, особенно с наполнением базы данных, инициализацией репликации и с маршрутизацией запросов. Всё было отлажено вручную и проверено на практике. Дополнительно описал проблемы и решение в файле README в каталоге custom-api. Готов пояснить каждый шаг.

Почему я отошел от исходной формулировки задания:
Исходная конфигурация из уроков курса была упрощена и в некоторых местах нерабочая. Для того чтобы всё работало стабильно и прозрачно, я доработал compose-файл, добавил инициализацию, второй экземпляр API, прокси через Nginx, Service Discovery через Consul и настроил кэш Redis. Пришлось потратить много времени, но отладить процесс, идеально разобраться как все работает и эти шаги сделали архитектуру ближе к реальной.

Состав проекта:
- MongoDB: шардирование и репликация. Настроены два шарда по три реплики.
- Mongos: маршрутизатор MongoDB.
- Redis: используется для кэширования запросов API.
- FastAPI-приложение: два экземпляра pymongo-api.
- Nginx: выполняет роль API Gateway и балансировщика.
- Consul: Service Discovery.
- nginx-cdn: отдача статики, имитация CDN.
- init-sharding.bat: автоматическая инициализация конфигурации кластера и загрузка данных.
- architecture.drawio: схема архитектуры.

Как запустить проект:
1. Очистить окружение, если проект запускался раньше:
docker rm -f configsvr mongos redis consul nginx pymongo-api pymongo-api-2 shard1-a shard1-b shard1-c shard2-a shard2-b shard2-c
docker volume prune -f

2. Запустить контейнеры:
docker compose up -d --build

3. Инициализировать конфигурацию кластера и загрузить данные:
.\init-sharding.bat

Как проверить работу компонентов:
Проверка репликации:
docker exec -it shard1-a mongosh --port 27018
rs.status()
Ожидается один PRIMARY и два SECONDARY.

Проверка кэша:
Открыть http://localhost:8088/helloDoc/users

Затем выполнить в PowerShell:
for ($i=0; $i -lt 10; $i++) {
  Invoke-RestMethod http://localhost:8088/helloDoc/users
  Start-Sleep -Milliseconds 300
}
Видно, что работает балансировка между api-1 и api-2, данные иногда берутся из кэша.

Проверка CDN:
Открыть http://localhost:8088/icon.svg — статика отдается напрямую.

Проверка Service Discovery:
Открыть интерфейс: http://localhost:8500/ui
Там отображаются оба API-инстанса.


